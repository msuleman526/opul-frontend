<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opul - Ride Sharing Platform</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(circle at center, #0b0c2a, #050517);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .logo {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #00f0ff, #a18cd1, #fbc2eb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(0, 240, 255, 0.5);
    }

    .credit-display {
      display: none;
      background: rgba(0, 240, 255, 0.1);
      border: 2px solid #00f0ff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }

    .credit-count {
      font-size: 24px;
      font-weight: bold;
      color: #00f0ff;
      margin-bottom: 5px;
    }

    .credit-label {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }

    .buy-credits-btn {
      background: linear-gradient(45deg, #ff6b35, #f7931e);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .buy-credits-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
    }

    .role-selection {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
      width: 100%;
    }

    .role-button {
      width: 100%;
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: 2px solid #00f0ff;
      background: linear-gradient(45deg,
          rgba(138, 43, 226, 0.3),
          rgba(0, 191, 255, 0.3));
      color: #00f0ff;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
    }

    .role-button:hover {
      background: linear-gradient(45deg,
          rgba(138, 43, 226, 0.6),
          rgba(0, 191, 255, 0.6));
      transform: translateY(-3px);
      box-shadow: 0 0 25px rgba(0, 240, 255, 0.6);
    }

    .ride-form {
      display: none;
      width: 100%;
      flex-direction: column;
      align-items: center;
    }

    .input-container {
      position: relative;
      width: 100%;
      margin: 10px 0;
    }

    .input-field,
    .dropdown,
    .button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #00f0ff;
      padding: 15px;
      background-color: #0b0c2a;
      color: #00f0ff;
      font-size: 16px;
      box-shadow: 0 0 8px #00f0ff66;
      outline: none;
      box-sizing: border-box;
    }

    .dropdown,
    .button {
      margin: 10px 0;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #0b0c2a;
      border: 1px solid #00f0ff;
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .autocomplete-item {
      padding: 12px 15px;
      cursor: pointer;
      color: #00f0ff;
      border-bottom: 1px solid rgba(0, 240, 255, 0.2);
      transition: background-color 0.2s;
    }

    .autocomplete-item:hover {
      background-color: rgba(0, 240, 255, 0.1);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .button {
      background: linear-gradient(45deg,
          rgba(138, 43, 226, 0.4),
          rgba(75, 0, 130, 0.4),
          rgba(0, 191, 255, 0.4),
          rgba(147, 0, 211, 0.4),
          rgba(0, 255, 255, 0.4));
      background-size: 400% 400%;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
      color: white;
      font-weight: bold;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow:
        0 0 20px rgba(138, 43, 226, 0.5),
        0 0 40px rgba(0, 191, 255, 0.3),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
      text-shadow:
        0 0 10px rgba(255, 255, 255, 0.8),
        0 0 20px rgba(138, 43, 226, 0.6);
      border-radius: 25px;
      animation: holographic 3s ease-in-out infinite;
    }

    .button::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg,
          #8a2be2, #4b0082, #00bfff, #9300d3, #00ffff, #da70d6);
      background-size: 400% 400%;
      border-radius: 25px;
      z-index: -1;
      animation: holographic 3s ease-in-out infinite;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow:
        0 0 30px rgba(138, 43, 226, 0.7),
        0 0 60px rgba(0, 191, 255, 0.5),
        inset 0 0 30px rgba(255, 255, 255, 0.2);
      animation-duration: 1.5s;
    }

    .button:hover::before {
      animation-duration: 1.5s;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    @keyframes holographic {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    .form-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      display: none;
      width: 100%;
      box-sizing: border-box;
    }

    .success {
      background-color: rgba(0, 255, 0, 0.1);
      border: 1px solid #00ff00;
      color: #00ff00;
    }

    .error {
      background-color: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff0000;
      color: #ff0000;
    }

    .info {
      background-color: rgba(0, 240, 255, 0.1);
      border: 1px solid #00f0ff;
      color: #00f0ff;
    }

    .warning {
      background-color: rgba(255, 165, 0, 0.1);
      border: 1px solid #ffa500;
      color: #ffa500;
    }

    .back-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .client-info {
      display: none;
      width: 100%;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }

    .small-input {
      font-size: 14px;
      padding: 12px;
    }

    .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .payment-content {
      background: #0b0c2a;
      border: 2px solid #00f0ff;
      border-radius: 12px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .payment-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .payment-btn {
      flex: 1;
      padding: 15px;
      border: 2px solid #00f0ff;
      background: rgba(0, 240, 255, 0.1);
      color: #00f0ff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .payment-btn:hover {
      background: rgba(0, 240, 255, 0.3);
      transform: translateY(-2px);
    }

    .close-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 24px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">OPUL</div>

    <!-- Credit Display -->
    <div class="credit-display" id="creditDisplay">
      <div class="credit-count" id="creditCount">Loading...</div>
      <div class="credit-label">Available Credits</div>
      <button class="buy-credits-btn" onclick="showPaymentModal()">
        üí≥ Buy Credits ($10 = 1 Credit)
      </button>
    </div>

    <!-- Role Selection -->
    <div class="role-selection" id="roleSelection">
      <button class="role-button" onclick="selectRole('client')">
        üöó I need a ride (Client)
      </button>
      <button class="role-button" onclick="selectRole('driver')">
        üöô I want to drive (Driver)
      </button>
    </div>

    <!-- Client Ride Request Form -->
    <div class="ride-form" id="rideForm">
      <button class="back-button" onclick="showRoleSelection()">‚Üê Back to Role Selection</button>

      <div class="input-container">
        <input class="input-field" type="text" id="addressInput" placeholder="Where should we pick you up?"
          autocomplete="off" />
        <div class="autocomplete-dropdown" id="addressDropdown"></div>
      </div>

      <select class="dropdown" id="timeSelect">
        <option disabled selected>How many hours?</option>
        <option value="1">1hr</option>
        <option value="2">2hrs</option>
        <option value="3">3hrs</option>
        <option value="4">4hrs</option>
        <option value="5">5hrs</option>
        <option value="6">6hrs</option>
        <option value="7">7hrs</option>
        <option value="8">8hrs</option>
        <option value="9">9hrs</option>
        <option value="10">10hrs</option>
      </select>

      <!-- Client Info -->
      <button class="button" style="background: rgba(0,240,255,0.2); font-size: 14px;" onclick="toggleClientInfo()">
        üìù Add Contact Info (Recommended)
      </button>

      <div class="client-info" id="clientInfo">
        <input class="input-field small-input" type="text" id="clientName" placeholder="Your name" />
        <input class="input-field small-input" type="tel" id="clientPhone" placeholder="Phone number" />
        <input class="input-field small-input" type="email" id="clientEmail" placeholder="Email address" />
      </div>

      <button class="button" id="requestRideBtn">Request Ride</button>

      <div class="form-message" id="formMessage"></div>
    </div>

    <!-- Payment Modal -->
    <div class="payment-modal" id="paymentModal">
      <div class="payment-content">
        <button class="close-modal" onclick="closePaymentModal()">√ó</button>
        <h3 style="color: #00f0ff; margin-top: 0;">Buy Credit</h3>
        <p>Pay $10 to get 1 credit</p>
        <p style="font-size: 14px; color: rgba(255,255,255,0.7);">
          Credits allow you to request rides without paying each time.
        </p>

        <div style="margin: 20px 0;">
          <input class="input-field small-input" type="email" id="paymentEmail" placeholder="Email address"
            style="margin-bottom: 10px;" />
          <input class="input-field small-input" type="tel" id="paymentPhone" placeholder="Phone number" />
        </div>

        <div class="payment-buttons">
          <button class="payment-btn" onclick="payWithPayPal()">
            PayPal
          </button>
          <button class="payment-btn" onclick="payWithStripe()">
            Stripe
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'http://localhost:5000/api';

    // Colombian addresses database
    const colombianAddresses = [
      'Carrera 43A # 11-30 Apto 501, El Poblado, Medell√≠n',
      'Calle 10 # 43B-73 Interior 201, El Poblado, Medell√≠n',
      'Carrera 37 # 8A-47 Torre 2 Apto 1204, El Poblado, Medell√≠n',
      'Transversal 5A # 45-67 Penthouse, El Poblado, Medell√≠n',
      'Carrera 43C # 9-15 Oficina 302, El Poblado, Medell√≠n',
      'Calle 9 # 43A-83 Local 105, El Poblado, Medell√≠n',
      'Carrera 38 # 10A-34 Apto 602, El Poblado, Medell√≠n',
      'Carrera 70 # 45E-139 Apto 803, Laureles, Medell√≠n',
      'Calle 33 # 70B-45 Interior 103, Laureles, Medell√≠n',
      'Circular 4 # 70-28 Torre A Apto 401, Laureles, Medell√≠n',
      'Carrera 73 # 39-42 Local 201, Laureles, Medell√≠n',
      'Calle 37 # 72C-15 Oficina 502, Laureles, Medell√≠n',
      'Carrera 75A # 33B-89 Apto 304, Laureles, Medell√≠n',
      'Carrera 76 # 30A-45 Casa 12, Bel√©n, Medell√≠n',
      'Calle 30 # 75B-67 Apto 201, Bel√©n, Medell√≠n',
      'Carrera 80 # 32-78 Interior 305, Bel√©n, Medell√≠n',
      'Diagonal 75 # 30C-23 Local 104, Bel√©n, Medell√≠n',
      'Carrera 50 # 53-28 Oficina 801, Centro, Medell√≠n',
      'Calle 52 # 49-35 Local 203, Centro, Medell√≠n',
      'Carrera 46 # 54A-67 Apto 402, Centro, Medell√≠n',
      'Calle 57 # 48-92 Interior 301, Centro, Medell√≠n',
      'Carrera 64 # 48B-34 Apto 502, Estadio, Medell√≠n',
      'Calle 48 # 65-78 Casa 23, Estadio, Medell√≠n',
      'Carrera 66A # 50-45 Local 106, Estadio, Medell√≠n',
      'Carrera 43A # 2Sur-67 Apto 703, Medell√≠n',
      'Calle 1Sur # 43B-89 Interior 204, Medell√≠n',
      'Carrera 43B # 27Sur-45 Apto 301, Envigado',
      'Calle 28Sur # 43A-78 Casa 15, Envigado',
      'Carrera 48 # 30Sur-23 Local 102, Envigado',
      'Transversal 38A # 32Sur-56 Oficina 401, Envigado',
      'Calle 32Sur # 44-67 Apto 602, Envigado',
      'Carrera 45 # 29Sur-34 Interior 203, Envigado',
      'Diagonal 35 # 43C-89 Torre B Apto 504, Envigado',
      'Calle 27Sur # 45A-45 Local 301, Envigado',
      'Carrera 42 # 34Sur-78 Casa 8, Envigado',
      'Calle 31Sur # 46-23 Apto 402, Envigado',
      'Carrera 44A # 33Sur-56 Oficina 205, Envigado',
      'Transversal 40 # 28Sur-67 Interior 105, Envigado',
      'Carrera 45A # 68Sur-34 Apto 201, Sabaneta',
      'Calle 70Sur # 44-89 Casa 25, Sabaneta',
      'Carrera 46 # 72Sur-45 Local 103, Sabaneta',
      'Calle 69Sur # 45B-78 Interior 302, Sabaneta',
      'Carrera 43 # 71Sur-23 Apto 504, Sabaneta',
      'Transversal 44 # 70Sur-56 Oficina 401, Sabaneta',
      'Calle 72Sur # 46A-67 Torre A Apto 602, Sabaneta',
      'Carrera 47 # 69Sur-34 Casa 12, Sabaneta',
      'Diagonal 45 # 73Sur-89 Local 205, Sabaneta',
      'Calle 68Sur # 43B-45 Apto 303, Sabaneta',
      'Carrera 44 # 74Sur-78 Interior 106, Sabaneta',
      'Calle 71Sur # 47A-23 Oficina 502, Sabaneta'
    ];

    // DOM elements
    const roleSelection = document.getElementById('roleSelection');
    const rideForm = document.getElementById('rideForm');
    const addressInput = document.getElementById('addressInput');
    const addressDropdown = document.getElementById('addressDropdown');
    const timeSelect = document.getElementById('timeSelect');
    const requestRideBtn = document.getElementById('requestRideBtn');
    const formMessage = document.getElementById('formMessage');
    const clientInfo = document.getElementById('clientInfo');
    const creditDisplay = document.getElementById('creditDisplay');
    const creditCount = document.getElementById('creditCount');
    const paymentModal = document.getElementById('paymentModal');

    // Global variables
    let currentCredits = 0;
    let userEmail = '';
    let userPhone = '';

    // Initialize on page load
    window.addEventListener('load', function () {
      initializeCredits();
      setupAddressAutocomplete();
      checkBackendConnection();
      handlePaymentSuccess();
    });

    // ALWAYS CREATE RIDE REQUEST - No credit check, just create and show to drivers
    async function createRideRequestAlways(address, duration, name, phone, email) {
      const rideData = {
        pickupLocation: {
          address: address,
          latitude: null,
          longitude: null
        },
        duration: duration,
        clientInfo: {
          name: name || 'Anonymous',
          phone: phone,
          email: email
        }
        // No hasCredits flag - always create
      };

      requestRideBtn.disabled = true;
      requestRideBtn.textContent = 'Creating request...';
      showMessage('Creating your ride request...', 'info');

      try {
        const response = await fetch(`${API_BASE}/rides/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(rideData)
        });

        const result = await response.json();

        if (result.success) {
          showMessage(`‚úÖ Ride request created successfully!\nRequest ID: ${result.data.requestId}\nDrivers can now see your request and make offers.`, 'success');

          // Update credits display
          await loadUserCredits();

          localStorage.setItem('currentRideRequest', JSON.stringify({
            requestId: result.data.requestId,
            pickupAddress: address,
            duration: duration,
            status: result.data.status
          }));

          // Redirect to drivers page to see offers (NO TIMER YET)
          setTimeout(() => {
            window.location.href = `drivers.html?requestId=${result.data.requestId}`;
          }, 2000);

        } else {
          showMessage(`Failed to create ride request: ${result.message}`, 'error');
        }
      } catch (error) {
        console.error('API Error:', error);
        showMessage('Network error. Please check your connection and try again.', 'error');
      } finally {
        requestRideBtn.disabled = false;
        requestRideBtn.textContent = 'Request Ride';
      }
    }
    async function initializeCredits() {
      userEmail = localStorage.getItem('userEmail') || '';
      userPhone = localStorage.getItem('userPhone') || '';

      if (userEmail || userPhone) {
        await loadUserCredits();
      } else {
        creditCount.textContent = '0';
      }
    }

    async function loadUserCredits() {
      try {
        const params = new URLSearchParams();
        if (userEmail) params.append('email', userEmail);
        if (userPhone) params.append('phone', userPhone);

        const response = await fetch(`${API_BASE}/credits?${params}`);
        const data = await response.json();

        if (data.success) {
          currentCredits = data.data.totalCredits;
          creditCount.textContent = currentCredits;
        } else {
          creditCount.textContent = '0';
        }
      } catch (error) {
        console.error('Error loading credits:', error);
        creditCount.textContent = '0';
      }
    }

    // Payment Modal Functions
    function showPaymentModal() {
      paymentModal.style.display = 'flex';
      if (userEmail) document.getElementById('paymentEmail').value = userEmail;
      if (userPhone) document.getElementById('paymentPhone').value = userPhone;
    }

    function closePaymentModal() {
      paymentModal.style.display = 'none';
    }

    async function payWithPayPal() {
      await processServiceFeePayment('paypal');
    }

    async function payWithStripe() {
      await processServiceFeePayment('stripe');
    }

    async function processServiceFeePayment(paymentMethod) {
      const email = document.getElementById('paymentEmail').value.trim();
      const phone = document.getElementById('paymentPhone').value.trim();

      if (!email && !phone) {
        showMessage('Please enter either email or phone number', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/payments/create-service-fee`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            phone,
            paymentMethod
          })
        });

        const data = await response.json();

        if (data.success) {
          if (email) localStorage.setItem('userEmail', email);
          if (phone) localStorage.setItem('userPhone', phone);

          if (paymentMethod === 'stripe') {
            window.location.href = data.data.checkoutUrl;
          } else {
            window.location.href = data.data.approvalUrl;
          }
        } else {
          showMessage(`Payment creation failed: ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('Payment error:', error);
        showMessage('Payment processing failed. Please try again.', 'error');
      }
    }

    // Role selection functions
    function selectRole(role) {
      if (role === 'client') {
        creditDisplay.style.display = 'block';
        showRideForm();
      } else if (role === 'driver') {
        creditDisplay.style.display = 'none';
        window.location.href = 'driver-portal.html';
      }
    }

    function showRideForm() {
      roleSelection.style.display = 'none';
      rideForm.style.display = 'flex';
      clientInfo.style.display = 'flex';
    }

    function showRoleSelection() {
      rideForm.style.display = 'none';
      roleSelection.style.display = 'flex';
      resetForm();
    }

    function resetForm() {
      addressInput.value = '';
      timeSelect.selectedIndex = 0;
      document.getElementById('clientName').value = '';
      document.getElementById('clientPhone').value = userPhone;
      document.getElementById('clientEmail').value = userEmail;
      hideMessage();
    }

    function toggleClientInfo() {
      const isVisible = clientInfo.style.display === 'flex';
      clientInfo.style.display = isVisible ? 'none' : 'flex';
    }

    // Address autocomplete setup
    function setupAddressAutocomplete() {
      addressInput.addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();

        if (query.length < 2) {
          addressDropdown.style.display = 'none';
          return;
        }

        const filteredAddresses = colombianAddresses.filter(address =>
          address.toLowerCase().includes(query)
        );

        if (filteredAddresses.length > 0) {
          addressDropdown.innerHTML = '';
          filteredAddresses.slice(0, 8).forEach(address => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = address;
            item.addEventListener('click', function () {
              addressInput.value = address;
              addressDropdown.style.display = 'none';
            });
            addressDropdown.appendChild(item);
          });
          addressDropdown.style.display = 'block';
        } else {
          addressDropdown.style.display = 'none';
        }
      });

      document.addEventListener('click', function (e) {
        if (!addressInput.contains(e.target) && !addressDropdown.contains(e.target)) {
          addressDropdown.style.display = 'none';
        }
      });
    }

    // NEW CORRECTED RIDE REQUEST FLOW - Always create request, check credits later
    requestRideBtn.addEventListener('click', async function () {
      const address = addressInput.value.trim();
      const duration = parseInt(timeSelect.value);
      const name = document.getElementById('clientName').value.trim();
      const phone = document.getElementById('clientPhone').value.trim();
      const email = document.getElementById('clientEmail').value.trim();

      hideMessage();

      if (!address) {
        showMessage('Please enter a pickup address', 'error');
        return;
      }

      if (!duration) {
        showMessage('Please select ride duration', 'error');
        return;
      }

      if (!email && !phone) {
        showMessage('Please enter either email or phone number', 'error');
        return;
      }

      const isValidAddress = colombianAddresses.some(addr =>
        addr.toLowerCase().includes(address.toLowerCase())
      ) || address.toLowerCase().includes('medell√≠n') ||
        address.toLowerCase().includes('medellin') ||
        address.toLowerCase().includes('envigado') ||
        address.toLowerCase().includes('sabaneta');

      if (!isValidAddress) {
        showMessage('Sorry, we only serve Medell√≠n, Envigado, and Sabaneta', 'error');
        return;
      }

      if (email) {
        localStorage.setItem('userEmail', email);
        userEmail = email;
      }
      if (phone) {
        localStorage.setItem('userPhone', phone);
        userPhone = phone;
      }

      // ALWAYS CREATE RIDE REQUEST (no credit check here)
      await createRideRequestAlways(address, duration, name, phone, email);
    });

    async function createRideRequest(address, duration, name, phone, email, hasCredits = false) {
      const rideData = {
        pickupLocation: {
          address: address,
          latitude: null,
          longitude: null
        },
        duration: duration,
        clientInfo: {
          name: name || 'Anonymous',
          phone: phone,
          email: email
        },
        hasCredits: hasCredits // Send this flag to the backend
      };

      requestRideBtn.textContent = 'Creating request...';
      showMessage('Creating your ride request...', 'info');

      try {
        const response = await fetch(`${API_BASE}/rides/request-corrected`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(rideData)
        });

        const result = await response.json();

        if (result.success) {
          if (hasCredits) {
            // User has credits - Show success and redirect to drivers page with timer
            showMessage(`‚úÖ Ride request created! Timer started.\nYou have 3 minutes to select a driver.`, 'success');
            
            localStorage.setItem('currentRideRequest', JSON.stringify({
              requestId: result.data.requestId,
              pickupAddress: address,
              duration: duration,
              status: result.data.status,
              timerStarted: true
            }));

            // Redirect to drivers page after 2 seconds
            setTimeout(() => {
              window.location.href = `drivers.html?requestId=${result.data.requestId}`;
            }, 2000);
          } else {
            // This should not happen in the corrected flow
            showMessage('Ride request created but payment required.', 'warning');
          }
        } else {
          showMessage(`Failed to create ride request: ${result.message}`, 'error');
        }
      } catch (error) {
        console.error('API Error:', error);
        showMessage('Network error. Please check your connection and try again.', 'error');
      }
    }

    async function createRideRequestAndHandlePayment(address, duration, name, phone, email) {
      const rideData = {
        pickupLocation: {
          address: address,
          latitude: null,
          longitude: null
        },
        duration: duration,
        clientInfo: {
          name: name || 'Anonymous',
          phone: phone,
          email: email
        },
        hasCredits: false // User doesn't have credits, will pay after
      };

      requestRideBtn.textContent = 'Creating request...';
      showMessage('Creating your ride request for drivers to see...', 'info');

      try {
        // STEP 1: Create ride request FIRST so drivers can see it
        const response = await fetch(`${API_BASE}/rides/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(rideData)
        });

        const result = await response.json();

        if (result.success) {
          const requestId = result.data.requestId;
          
          showMessage(`‚úÖ Ride request created! Drivers can now see your request.\nRequest ID: ${requestId}\n\nNow please pay $10 to proceed with driver selection.`, 'success');

          // Store ride request data for after payment
          localStorage.setItem('currentRideRequest', JSON.stringify({
            requestId: requestId,
            pickupAddress: address,
            duration: duration,
            status: result.data.status,
            needsPayment: true
          }));

          // STEP 2: Show payment options with the request ID
          showPaymentOptionsForExistingRide(requestId, address, duration, name, phone, email);
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('Error creating ride request:', error);
        showMessage(`Failed to create ride request: ${error.message}`, 'error');
      }
    }

    function showPaymentOptionsForExistingRide(requestId, address, duration, name, phone, email) {
      // Store both ride data and request ID for after payment
      localStorage.setItem('pendingRidePayment', JSON.stringify({
        requestId: requestId,
        address, duration, name, phone, email
      }));

      // Show payment modal
      showPaymentModal();
      
      // Update payment modal to show it's for an existing ride
      const paymentContent = document.querySelector('.payment-content h3');
      paymentContent.innerHTML = 'üí≥ Complete Your Ride Request';
      
      const paymentInfo = document.querySelector('.payment-content p');
      paymentInfo.innerHTML = `Your ride request has been created and drivers can see it!<br><br>Pay $10 to get 1 credit and proceed with driver selection.<br><br><strong>Request ID:</strong> ${requestId}`;
    }

    // Modified payment processing to handle existing ride requests
    async function processServiceFeePayment(paymentMethod) {
      const email = document.getElementById('paymentEmail').value.trim();
      const phone = document.getElementById('paymentPhone').value.trim();

      if (!email && !phone) {
        showMessage('Please enter either email or phone number', 'error');
        return;
      }

      // Check if this payment is for an existing ride request
      const pendingRidePayment = localStorage.getItem('pendingRidePayment');
      const isForRide = !!pendingRidePayment;
      let rideData = null;
      
      if (isForRide) {
        rideData = JSON.parse(pendingRidePayment);
        console.log('üöó Processing service fee payment for existing ride:', rideData.requestId);
      }

      try {
        const response = await fetch(`${API_BASE}/payments/create-service-fee`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            phone,
            paymentMethod,
            isForRide: isForRide,
            requestId: rideData?.requestId // Send requestId if this is for a ride
          })
        });

        const data = await response.json();

        if (data.success) {
          if (email) localStorage.setItem('userEmail', email);
          if (phone) localStorage.setItem('userPhone', phone);

          // Add a flag to identify this as ride payment
          if (isForRide) {
            localStorage.setItem('paymentForExistingRide', 'true');
            localStorage.setItem('paymentRequestId', rideData.requestId);
          }

          if (paymentMethod === 'stripe') {
            window.location.href = data.data.checkoutUrl;
          } else {
            window.location.href = data.data.approvalUrl;
          }
        } else {
          showMessage(`Payment creation failed: ${data.message}`, 'error');
        }
      } catch (error) {
        console.error('Payment error:', error);
        showMessage('Payment processing failed. Please try again.', 'error');
      }
    }

    // Message functions
    function showMessage(text, type) {
      formMessage.innerHTML = text.replace(/\n/g, '<br>');
      formMessage.className = `form-message ${type}`;
      formMessage.style.display = 'block';
    }

    function hideMessage() {
      formMessage.style.display = 'none';
    }

    // Enable Enter key submission
    addressInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        addressDropdown.style.display = 'none';
        requestRideBtn.click();
      }
    });

    // Check backend connection
    async function checkBackendConnection() {
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        if (!data.status === 'OK') {
          console.warn('Backend may not be running');
        }
      } catch (error) {
        console.warn('Cannot connect to backend. Make sure the server is running on http://localhost:5000');
      }
    }

    // Handle payment success - Modified for new ride flow
    function handlePaymentSuccess() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentForExistingRide = localStorage.getItem('paymentForExistingRide');
      const paymentRequestId = localStorage.getItem('paymentRequestId');
      
      if (urlParams.get('payment') === 'success') {
        showMessage('Payment successful! 1 credit has been added to your account.', 'success');
        
        if (paymentForExistingRide === 'true' && paymentRequestId) {
          // Payment was for an existing ride - redirect to drivers page with timer
          setTimeout(async () => {
            await loadUserCredits(); // Refresh credits
            localStorage.removeItem('pendingRidePayment');
            localStorage.removeItem('paymentForExistingRide');
            
            showMessage('Payment complete! Now starting driver selection timer...', 'success');
            
            // Start timer for the existing ride request
            try {
              const response = await fetch(`${API_BASE}/rides/${paymentRequestId}/start-timer`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                }
              });
              
              const result = await response.json();
              if (result.success) {
                console.log('‚úÖ Timer started for existing ride request');
              }
            } catch (error) {
              console.error('Error starting timer:', error);
            }
            
            // Redirect to drivers page
            setTimeout(() => {
              window.location.href = `drivers.html?requestId=${paymentRequestId}`;
            }, 2000);
          }, 2000);
        } else {
          // Regular credit purchase
          setTimeout(() => {
            loadUserCredits();
            localStorage.removeItem('paymentRequestId');
            window.history.replaceState({}, document.title, window.location.pathname);
          }, 2000);
        }
      }
    }
  </script>
</body>

</html>