<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Dashboard - Opul</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap');

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(circle at center, #0b0c2a, #050517);
      color: white;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(11, 12, 42, 0.8);
      border: 2px solid #00f0ff;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.3);
    }

    .logo {
      font-size: 32px;
      font-weight: bold;
      background: linear-gradient(45deg, #00f0ff, #a18cd1, #fbc2eb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .driver-info {
      text-align: center;
    }

    .driver-name {
      font-size: 24px;
      color: #00f0ff;
      margin-bottom: 5px;
    }

    .driver-status {
      font-size: 14px;
      color: #a18cd1;
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

    .status-toggle {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      color: #00ff00;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .status-toggle.offline {
      background: rgba(255, 107, 107, 0.2);
      border-color: #ff6b6b;
      color: #ff6b6b;
    }

    .status-toggle:hover {
      transform: translateY(-2px);
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .stats-card,
    .rides-card {
      background: rgba(11, 12, 42, 0.8);
      border: 1px solid #a18cd1;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 0 15px rgba(161, 140, 209, 0.3);
    }

    .card-title {
      font-size: 20px;
      color: #00f0ff;
      margin-bottom: 20px;
      text-align: center;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 240, 255, 0.1);
      border-radius: 8px;
    }

    .stat-label {
      color: #a18cd1;
    }

    .stat-value {
      color: #00ff00;
      font-weight: bold;
    }

    .available-rides {
      grid-column: 1 / -1;
    }

    .rides-grid {
      display: grid;
      gap: 15px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .ride-card {
      background: rgba(11, 12, 42, 0.6);
      border: 1px solid #fbc2eb;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
    }

    .ride-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 20px rgba(251, 194, 235, 0.4);
    }

    .ride-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .ride-id {
      font-size: 16px;
      color: #00f0ff;
      font-weight: bold;
    }

    .ride-time {
      font-size: 12px;
      color: #888;
    }

    .ride-details {
      margin: 15px 0;
      color: #a18cd1;
      line-height: 1.6;
    }

    .ride-location {
      color: #fbc2eb;
      font-weight: bold;
      margin: 10px 0;
    }

    .ride-price {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
      padding: 10px;
      background: rgba(251, 194, 235, 0.1);
      border-radius: 8px;
    }

    .upfront-fee {
      color: #00ff00;
      font-weight: bold;
    }

    .potential-earnings {
      color: #ffd700;
      font-size: 14px;
    }

    .offer-button {
      width: 100%;
      background: linear-gradient(45deg, rgba(0, 255, 0, 0.6), rgba(0, 200, 0, 0.6));
      border: 2px solid #00ff00;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 12px;
      margin-top: 15px;
    }

    .offer-button:hover {
      background: linear-gradient(45deg, rgba(0, 255, 0, 0.8), rgba(0, 200, 0, 0.8));
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
    }

    .offer-button:disabled {
      background: rgba(128, 128, 128, 0.3);
      border-color: #666;
      color: #999;
      cursor: not-allowed;
      transform: none;
    }

    .chat-button {
      width: 100%;
      background: linear-gradient(45deg, rgba(0, 240, 255, 0.6), rgba(161, 140, 209, 0.6));
      border: 2px solid #00f0ff;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 12px;
      margin-top: 10px;
    }

    .chat-button:hover {
      background: linear-gradient(45deg, rgba(0, 240, 255, 0.8), rgba(161, 140, 209, 0.8));
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(0, 240, 255, 0.5);
    }

    /* In Progress Ride Cards */
    .in-progress-card {
      background: rgba(11, 12, 42, 0.6);
      border: 2px solid #ffd700;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
    }

    .in-progress-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    }

    .progress-badge {
      position: absolute;
      top: -8px;
      right: 15px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #0b0c2a;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .no-rides {
      text-align: center;
      padding: 40px;
      color: #a18cd1;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 3px solid rgba(0, 240, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #00f0ff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(45deg, #00f0ff, #a18cd1);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .refresh-button {
      background: rgba(0, 240, 255, 0.2);
      border: 1px solid #00f0ff;
      color: #00f0ff;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin: 20px auto;
      display: block;
      transition: all 0.3s ease;
    }

    .refresh-button:hover {
      background: rgba(0, 240, 255, 0.3);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .header-actions {
        justify-content: center;
      }
    }
  </style>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">OPUL</div>
      <div class="driver-info">
        <div class="driver-name" id="driverName">Driver Name</div>
        <div class="driver-status" id="driverStatus">Vehicle: Loading...</div>
      </div>
      <div class="header-actions">
        <button class="status-toggle" id="statusToggle" onclick="toggleOnlineStatus()">
          üü¢ Online
        </button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Stats Card -->
      <div class="stats-card">
        <div class="card-title">üìä Driver Statistics</div>
        <div class="stat-item">
          <span class="stat-label">Total Rides:</span>
          <span class="stat-value" id="totalRides">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total Earnings:</span>
          <span class="stat-value" id="totalEarnings">$0.00</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Rating:</span>
          <span class="stat-value" id="driverRating">5.0/5</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">This Month:</span>
          <span class="stat-value" id="monthlyEarnings">$0.00</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Hourly Rate:</span>
          <span class="stat-value" id="hourlyRate">$0/hr</span>
        </div>
      </div>

      <!-- Active Rides Card -->
      <div class="stats-card">
        <div class="card-title">üöó Current Status</div>
        <div class="stat-item">
          <span class="stat-label">Status:</span>
          <span class="stat-value" id="currentStatus">Offline</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Available:</span>
          <span class="stat-value" id="availabilityStatus">Not Available</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Active Ride:</span>
          <span class="stat-value" id="activeRide">None</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Monthly Rides:</span>
          <span class="stat-value" id="monthlyRides">0</span>
        </div>
      </div>
    </div>

    <!-- In Progress Rides Section -->
    <div class="stats-card available-rides" id="inProgressSection">
      <div class="card-title">üöó In Progress Rides</div>

      <button class="refresh-button" onclick="loadInProgressRides()">üîÑ Refresh In Progress</button>

      <div class="loading" id="inProgressLoadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <p>Loading in progress rides...</p>
      </div>

      <div class="rides-grid" id="inProgressGrid"></div>

      <div class="no-rides" id="noInProgressRides" style="display: none;">
        <h3>No rides in progress</h3>
        <p>When you start a ride, it will appear here for easy chat access.</p>
      </div>
    </div>

    <!-- Available Rides -->
    <div class="stats-card available-rides">
      <div class="card-title">üöÄ Available Ride Requests</div>

      <button class="refresh-button" onclick="forceRefreshRides()">üîÑ Refresh Rides</button>

      <div class="loading" id="loadingIndicator" style="display: none;">
        <div class="spinner"></div>
        <p>Loading available rides...</p>
      </div>

      <div class="rides-grid" id="ridesGrid"></div>

      <div class="no-rides" id="noRides" style="display: none;">
        <h3>No ride requests available</h3>
        <p>When clients request rides in your area, they will appear here.</p>
        <p>Make sure you're online and available to receive ride requests.</p>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'https://opul-backend-qt2a.onrender.com/api';

    // Global variables
    let socket = null;
    let driverInfo = null;
    let driverToken = null;
    let isOnline = false;
    let isAvailable = true;

    // Initialize dashboard
    window.addEventListener('load', async function () {
      // Check authentication
      driverToken = localStorage.getItem('driverToken');
      const storedDriverInfo = localStorage.getItem('driverInfo');

      if (!driverToken || !storedDriverInfo) {
        alert('Please login first');
        window.location.href = 'driver-portal.html';
        return;
      }

      driverInfo = JSON.parse(storedDriverInfo);

      // Initialize page
      await initializeDashboard();
    });

    // Test backend connection
    async function testBackendConnection() {
      try {
        console.log('Testing backend connection...');
        const response = await fetch(`${API_BASE}/health`);

        console.log('Health check response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Health check error:', errorText);
          showNotification('Backend server is not responding properly');
          return false;
        }

        const data = await response.json();
        console.log('Health check response:', data);

        if (data.status === 'OK') {
          console.log('Backend connection successful');
          return true;
        } else {
          console.warn('Backend responded but status is not OK:', data);
          return false;
        }
      } catch (error) {
        console.error('Backend connection test failed:', error);
        showNotification('Cannot connect to backend server. Please make sure it is running on https://opul-backend-qt2a.onrender.com');
        return false;
      }
    }

    async function initializeDashboard() {
      // Test backend connection first
      const isConnected = await testBackendConnection();
      if (!isConnected) {
        console.error('Backend connection failed, stopping initialization');
        return;
      }

      // Initialize Socket.IO
      try {
        socket = io('https://opul-backend-qt2a.onrender.com');
        setupSocketListeners();
      } catch (error) {
        console.warn('Socket.IO connection failed:', error);
      }

      // Load dashboard data
      await loadDashboardData();

      // Load in-progress rides
      await loadInProgressRides();

      // Load available rides
      await loadAvailableRides();

      // Auto-refresh rides every 30 seconds
      setInterval(() => {
        loadInProgressRides();
        loadAvailableRides();
      }, 30000);
    }

    function setupSocketListeners() {
      socket.on('connect', () => {
        console.log('Connected to server');
      });

      socket.on('new-ride-request', (data) => {
        console.log('New ride request:', data);
        loadAvailableRides(); // Refresh rides
        showNotification(`New ride request: ${data.pickupLocation.address}`);
      });

      socket.on('ride-cancelled', (data) => {
        loadAvailableRides(); // Refresh rides
        loadInProgressRides(); // Refresh in-progress rides
        showNotification('A ride request was cancelled');
      });

      socket.on('ride-started', (data) => {
        loadInProgressRides(); // Refresh in-progress rides
        showNotification('Ride has been started!');
      });

      socket.on('ride-ended', (data) => {
        loadInProgressRides(); // Refresh in-progress rides
        showNotification('Ride has been completed!');
      });

      socket.on('ride-expired', (data) => {
        console.log('Ride expired:', data);
        loadAvailableRides(); // Refresh rides to remove expired ones
        showNotification('A ride request expired due to timer');
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
      });
    }

    async function loadDashboardData() {
      try {
        const response = await fetch(`${API_BASE}/drivers/dashboard`, {
          headers: {
            'Authorization': `Bearer ${driverToken}`
          }
        });

        console.log('Dashboard API response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Dashboard API response error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const responseText = await response.text();
        console.log('Dashboard raw API response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Dashboard JSON parse error:', parseError);
          console.error('Response text that failed to parse:', responseText);
          throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }

        console.log('Dashboard parsed API response:', data);

        if (data.success) {
          updateDashboardDisplay(data.data);
        } else {
          throw new Error(data.message || 'Unknown API error');
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification(`Error loading dashboard data: ${error.message}`);
      }
    }

    function updateDashboardDisplay(dashboardData) {
      const { driver, stats } = dashboardData;

      // Update driver info
      document.getElementById('driverName').textContent = driver.name;
      document.getElementById('driverStatus').textContent = `${driver.vehicleType} - ${driver.vehicleModel}`;

      // Update stats
      document.getElementById('totalRides').textContent = stats.totalRides;
      document.getElementById('totalEarnings').textContent = `$${stats.totalEarnings.toFixed(2)}`;
      document.getElementById('driverRating').textContent = `${stats.rating}/5`;
      document.getElementById('monthlyEarnings').textContent = `$${stats.monthlyEarnings.toFixed(2)}`;
      document.getElementById('monthlyRides').textContent = stats.monthlyRides;
      document.getElementById('hourlyRate').textContent = `$${driver.hourlyRate}/hr`;

      // Update status
      isOnline = stats.isOnline;
      isAvailable = true;

      updateStatusDisplay();
    }

    function updateStatusDisplay() {
      const statusToggle = document.getElementById('statusToggle');
      const currentStatus = document.getElementById('currentStatus');
      const availabilityStatus = document.getElementById('availabilityStatus');

      if (isOnline) {
        statusToggle.textContent = 'üü¢ Online';
        statusToggle.classList.remove('offline');
        currentStatus.textContent = 'Online';
        currentStatus.style.color = '#00ff00';
      } else {
        statusToggle.textContent = 'üî¥ Offline';
        statusToggle.classList.add('offline');
        currentStatus.textContent = 'Offline';
        currentStatus.style.color = '#ff6b6b';
      }

      if (isAvailable) {
        availabilityStatus.textContent = 'Available';
        availabilityStatus.style.color = '#00ff00';
      } else {
        availabilityStatus.textContent = 'Busy';
        availabilityStatus.style.color = '#ffd700';
      }
    }

    async function toggleOnlineStatus() {
      try {
        const newStatus = !isOnline;
        console.log('Toggling online status from', isOnline, 'to', newStatus);
        console.log('Driver info:', driverInfo);
        console.log('Driver token:', driverToken ? 'Present' : 'Missing');

        const response = await fetch(`${API_BASE}/drivers/online`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${driverToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isOnline: newStatus })
        });

        console.log('Online status response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Online status error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const responseText = await response.text();
        console.log('Online status raw response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Online status JSON parse error:', parseError);
          throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }

        console.log('Online status parsed response:', data);

        if (data.success) {
          isOnline = newStatus;
          isAvailable = true; // Assume available when going online
          updateStatusDisplay();
          showNotification(`You are now ${newStatus ? 'online' : 'offline'}`);

          if (newStatus) {
            console.log('Going online - loading available rides');
            loadAvailableRides(); // Load rides when going online
          }
        } else {
          throw new Error(data.message || 'Unknown error updating status');
        }
      } catch (error) {
        console.error('Error updating status:', error);
        showNotification(`Error updating status: ${error.message}`);
      }
    }

    // Check current driver status from backend
    async function checkDriverStatus() {
      try {
        console.log('Checking driver status from backend...');
        showNotification('Checking your current status...');

        const response = await fetch(`${API_BASE}/drivers/dashboard`, {
          headers: {
            'Authorization': `Bearer ${driverToken}`
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Status check error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('Current driver status from backend:', data);

        if (data.success && data.data && data.data.stats) {
          const backendOnline = data.data.stats.isOnline;
          const backendAvailable = data.data.stats.isAvailable;

          console.log('Backend says - Online:', backendOnline, 'Available:', backendAvailable);
          console.log('Frontend thinks - Online:', isOnline, 'Available:', isAvailable);

          // Update frontend state to match backend
          isOnline = backendOnline;
          isAvailable = true;
          updateStatusDisplay();

          showNotification(`Status updated - Online: ${isOnline}, Available: ${isAvailable}`);

          // If we're now online, try to load rides
          if (isOnline) {
            loadAvailableRides();
          }
        } else {
          throw new Error('Invalid response format');
        }
      } catch (error) {
        console.error('Error checking driver status:', error);
        showNotification(`Error checking status: ${error.message}`);
      }
    }

    async function loadAvailableRides() {
      // Only load rides if driver is online (normal operation)
      if (!isOnline) {
        console.log('Driver is offline, not loading rides');
        const ridesGrid = document.getElementById('ridesGrid');
        const noRides = document.getElementById('noRides');
        ridesGrid.innerHTML = '';
        noRides.style.display = 'block';
        return;
      }

      console.log('Loading available rides for online driver...');

      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('noRides').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/rides/active`, {
          headers: {
            'Authorization': `Bearer ${driverToken}`
          }
        });

        console.log('Rides API response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('API response error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const responseText = await response.text();
        console.log('Raw API response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          console.error('Response text that failed to parse:', responseText);
          throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }

        console.log('Parsed rides API response:', data);

        if (data.success) {
          displayAvailableRides(data.data);
        } else {
          throw new Error(data.message || 'Unknown API error');
        }
      } catch (error) {
        console.error('Error loading rides:', error);
        showNotification(`Error loading available rides: ${error.message}`);
        displayAvailableRides([]); // Show empty state
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    }

    // Load in-progress rides for the driver
    async function loadInProgressRides() {
      console.log('Loading in-progress rides for driver...');

      document.getElementById('inProgressLoadingIndicator').style.display = 'block';
      document.getElementById('noInProgressRides').style.display = 'none';

      try {
        // Use the new dedicated endpoint for driver's active rides
        const response = await fetch(`${API_BASE}/rides/driver/active`, {
          headers: {
            'Authorization': `Bearer ${driverToken}`
          }
        });

        console.log('Driver active rides API response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Driver active rides API response error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const responseText = await response.text();
        console.log('Driver active rides raw API response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Driver active rides JSON parse error:', parseError);
          console.error('Response text that failed to parse:', responseText);
          throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }

        console.log('Driver active rides parsed API response:', data);

        if (data.success) {
          displayInProgressRides(data.data || []);
        } else {
          throw new Error(data.message || 'Unknown API error');
        }
      } catch (error) {
        console.error('Error loading in-progress rides:', error);
        showNotification(`Error loading in-progress rides: ${error.message}`);
        displayInProgressRides([]); // Show empty state
      } finally {
        document.getElementById('inProgressLoadingIndicator').style.display = 'none';
      }
    }



    function displayInProgressRides(rides) {
      console.log('Displaying in-progress rides:', rides);

      const inProgressGrid = document.getElementById('inProgressGrid');
      const noInProgressRides = document.getElementById('noInProgressRides');

      if (rides.length === 0) {
        console.log('No in-progress rides found');
        inProgressGrid.innerHTML = '';
        noInProgressRides.style.display = 'block';
        return;
      }

      console.log(`Found ${rides.length} in-progress rides`);
      noInProgressRides.style.display = 'none';
      inProgressGrid.innerHTML = '';

      rides.forEach(ride => {
        console.log('Creating in-progress card for ride:', ride.requestId);
        const rideCard = createInProgressRideCard(ride);
        inProgressGrid.appendChild(rideCard);
      });
    }

    function createInProgressRideCard(ride) {
      const card = document.createElement('div');
      card.className = 'in-progress-card';

      // Handle different date formats
      let startedTime = 'Not started';
      if (ride.rideDetails && ride.rideDetails.startTime) {
        startedTime = new Date(ride.rideDetails.startTime).toLocaleTimeString();
      } else if (ride.status === 'matched') {
        startedTime = 'Matched - Not started';
      }

      const statusText = ride.status === 'in_progress' ? 'In Progress' : 'Matched';
      const statusColor = ride.status === 'in_progress' ? '#ffd700' : '#00ff00';

      // Correct calculation: Driver earns hourly rate * duration
      const driverEarnings = (driverInfo.hourlyRate * ride.duration).toFixed(2);
      // Customer will pay: driver earnings + 10% tip
      const tip = (driverEarnings * 0.1).toFixed(2);
      const customerWillPay = (parseFloat(driverEarnings) + parseFloat(tip)).toFixed(2);

      card.innerHTML = `
        <div class="progress-badge">${statusText.toUpperCase()}</div>
        <div class="ride-header">
          <div class="ride-id">Ride: ${ride.requestId}</div>
          <div class="ride-time">${startedTime}</div>
        </div>
        <div class="ride-location">
          üìç ${ride.pickupLocation.address}
        </div>
        <div class="ride-details">
          <div>üë§ Client: ${ride.clientInfo ? ride.clientInfo.name : 'Loading...'}</div>
          <div>‚è±Ô∏è Duration: ${ride.duration} hour(s)</div>
          <div>üí∞ User will Pay: ${customerWillPay}</div>
          <div>üíµ You will get: ${driverEarnings}</div>
          <div style="color: ${statusColor};">üöó Status: ${statusText}</div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="chat-button" onclick="openChat('${ride.requestId}')" style="flex: 1;">
            üí¨ Open Chat
          </button>
          ${ride.status === 'matched' ? `
            <button class="offer-button" onclick="startRide('${ride.requestId}')" style="flex: 1; background: linear-gradient(45deg, rgba(255, 215, 0, 0.6), rgba(255, 193, 7, 0.6)); border-color: #ffd700;">
              üöÄ Start Ride
            </button>
          ` : ''}
          ${ride.status === 'in_progress' ? `
            <button class="offer-button" onclick="endRide('${ride.requestId}')" style="flex: 1; background: linear-gradient(45deg, rgba(255, 0, 0, 0.6), rgba(220, 53, 69, 0.6)); border-color: #ff0000;">
              üèÅ End Ride
            </button>
          ` : ''}
        </div>
      `;

      return card;
    }

    // Force refresh rides (for debugging - bypasses online check)
    async function forceRefreshRides() {
      console.log('Force refreshing rides (bypassing online check)...');

      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('noRides').style.display = 'none';

      try {
        console.log('Fetching rides from:', `${API_BASE}/rides/active`);

        const response = await fetch(`${API_BASE}/rides/active`);

        console.log('Force refresh API response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Force refresh API response error:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const responseText = await response.text();
        console.log('Force refresh raw API response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Force refresh JSON parse error:', parseError);
          console.error('Response text that failed to parse:', responseText);
          throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }

        console.log('Force refresh parsed API response:', data);

        if (data.success) {
          displayAvailableRides(data.data);
        } else {
          throw new Error(data.message || 'Unknown API error');
        }
      } catch (error) {
        console.error('Error loading rides:', error);
        showNotification(`Error loading available rides: ${error.message}`);
        displayAvailableRides([]); // Show empty state
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    }

    function displayAvailableRides(rides) {
      console.log('Displaying rides:', rides);

      const ridesGrid = document.getElementById('ridesGrid');
      const noRides = document.getElementById('noRides');

      if (rides.length === 0) {
        console.log('No rides found');
        ridesGrid.innerHTML = '';
        noRides.style.display = 'block';
        return;
      }

      console.log(`Found ${rides.length} rides`);
      noRides.style.display = 'none';
      ridesGrid.innerHTML = '';

      rides.forEach(ride => {
        console.log('Creating card for ride:', ride.requestId);
        const rideCard = createRideCard(ride);
        ridesGrid.appendChild(rideCard);
      });
    }

    function createRideCard(ride) {
      const card = document.createElement('div');
      card.className = 'ride-card';

      const createdTime = new Date(ride.createdAt).toLocaleTimeString();

      // Correct calculation: Driver earns hourly rate * duration
      const driverEarnings = (driverInfo.hourlyRate * ride.duration).toFixed(2);
      // Customer will pay: driver earnings + 10% tip
      const tip = (driverEarnings * 0.1).toFixed(2);
      const customerWillPay = (parseFloat(driverEarnings) + parseFloat(tip)).toFixed(2);

      const alreadyOffered = ride.driverOffers?.some(offer =>
        offer.driver === driverInfo.id && offer.status === 'pending'
      );

      card.innerHTML = `
        <div class="ride-header">
          <div class="ride-id">Request: ${ride.requestId}</div>
          <div class="ride-time">${createdTime}</div>
        </div>
        <div class="ride-location">
          üìç ${ride.pickupLocation.address}
        </div>
        <div class="ride-details">
          <div>‚è±Ô∏è Duration: ${ride.duration} hour(s)</div>
          <div>üë• Offers: ${ride.driverOffers?.length || 0}</div>
        </div>
        <div class="ride-price">
          <div class="upfront-fee">User will Pay: ${customerWillPay}</div>
          <div class="potential-earnings">You will get: ${driverEarnings}</div>
        </div>
        <button class="offer-button" 
                onclick="makeOffer('${ride.requestId}')" 
                ${alreadyOffered ? 'disabled' : ''}>
          ${alreadyOffered ? '‚úì Offer Sent' : 'üöó Make Offer'}
        </button>
        ${ride.status === 'accepted' ? `
        <button class="chat-button" onclick="openChat('${ride.requestId}')">
          üí¨ Open Chat
        </button>` : ''}
      `;

      return card;
    }

    async function makeOffer(requestId) {
      console.log('Making offer for requestId:', requestId);
      console.log('Current status - isOnline:', isOnline, 'isAvailable:', isAvailable);
      console.log('Driver info:', driverInfo);

      if (!isOnline || !isAvailable) {
        const message = `Cannot make offer - Online: ${isOnline}, Available: ${isAvailable}`;
        console.error(message);
        showNotification('You must be online and available to make offers');
        return;
      }

      try {
        console.log('Sending offer request...');
        const response = await fetch(`${API_BASE}/rides/${requestId}/offer`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${driverToken}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Offer response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Offer error response:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const responseText = await response.text();
        console.log('Offer raw response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Offer JSON parse error:', parseError);
          throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
        }

        console.log('Offer parsed response:', data);

        if (data.success) {
          showNotification('Offer submitted successfully!');
          loadAvailableRides(); // Refresh to show updated status
        } else {
          throw new Error(data.message || 'Unknown error making offer');
        }
      } catch (error) {
        console.error('Error making offer:', error);
        showNotification(`Failed to make offer: ${error.message}`);
      }
    }

    async function logout() {
      try {
        // Call logout API
        await fetch(`${API_BASE}/auth/logout`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ driverId: driverInfo.id })
        });
      } catch (error) {
        console.error('Logout error:', error);
      }

      // Clear local storage
      localStorage.removeItem('driverToken');
      localStorage.removeItem('driverInfo');

      // Disconnect socket
      if (socket) {
        socket.disconnect();
      }

      // Redirect to home
      window.location.href = 'Index.html';
    }

    function openChat(requestId) {
      console.log('Opening chat for requestId:', requestId);
      console.log('Driver token:', driverToken ? 'Present' : 'Missing');
      console.log('Driver info:', driverInfo);

      // Set driver token and user type for chat
      localStorage.setItem('driverToken', driverToken);

      // Open chat in new window/tab
      const chatUrl = `Chat.html?requestId=${requestId}&userType=driver`;
      console.log('Opening chat URL:', chatUrl);

      const chatWindow = window.open(chatUrl, '_blank', 'width=400,height=600,scrollbars=yes,resizable=yes');

      if (!chatWindow) {
        console.error('Failed to open chat window - popup might be blocked');
        showNotification('Failed to open chat. Please allow popups and try again.');
        // Fallback: try to navigate in current tab
        if (confirm('Chat popup was blocked. Open in current tab instead?')) {
          window.location.href = chatUrl;
        }
      } else {
        console.log('Chat window opened successfully');
        showNotification('Chat window opened!');
      }
    }

    async function startRide(requestId) {
      console.log('Starting ride:', requestId);

      try {
        const response = await fetch(`${API_BASE}/rides/${requestId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${driverToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        if (data.success) {
          showNotification('Ride started successfully!');
          loadInProgressRides(); // Refresh the in-progress rides
        } else {
          throw new Error(data.message || 'Unknown error starting ride');
        }
      } catch (error) {
        console.error('Error starting ride:', error);
        showNotification(`Failed to start ride: ${error.message}`);
      }
    }

    async function endRide(requestId) {
      if (!confirm('Are you sure you want to end this ride?')) {
        return;
      }

      console.log('Ending ride:', requestId);

      try {
        const response = await fetch(`${API_BASE}/rides/${requestId}/end`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${driverToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        if (data.success) {
          showNotification('Ride completed successfully!');
          loadInProgressRides(); // Refresh the in-progress rides
          loadDashboardData(); // Refresh stats
        } else {
          throw new Error(data.message || 'Unknown error ending ride');
        }
      } catch (error) {
        console.error('Error ending ride:', error);
        showNotification(`Failed to end ride: ${error.message}`);
      }
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
</body>

</html>